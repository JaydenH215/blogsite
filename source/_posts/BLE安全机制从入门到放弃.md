---
title: BLE安全机制从入门到放弃
date: 2019-05-14 13:02:11
tags:
- BLE
- 安全机制
- 蓝牙

categories:
- 一得之见

top: true
---

网上介绍BLE安全机制的文章大多只关注业务概念，如：配对加密是什么，绑定过程是什么；而忽略了其中涉及到的信息安全知识，如：使用了加密和认证有什么用，不用又会怎么样。让新人读了有种云里雾里，知其然而不知其所以然的感觉。这里结合涉及到的信息安全知识，换一个角度来认识BLE安全机制。
<!-- more --> 

前言
===

标题中的“放弃”有点调侃的意思，是指读者在读完之后，可以不依赖别人，靠自己读蓝牙核心规范加深认识，这样收获也会更多，也是这篇博文的目标。

为了易于理解，会对蓝牙核心规范以及组网规范中的算法进行裁剪，但是原理是不变的，标准算法应参考蓝牙核心规范以及组网规范。

最后，这是博主的一得之见，欢迎各位指正。

目录
===

<!-- TOC -->

- [密码技术初探](#密码技术初探)
    - [对称密码](#对称密码)
    - [diffie-hellman密钥交换算法](#diffie-hellman密钥交换算法)
    - [椭圆曲线diffie-hellman密钥交换算法](#椭圆曲线diffie-hellman密钥交换算法)
    - [消息认证码](#消息认证码)
    - [信息安全小结](#信息安全小结)
- [ble安全机制初探](#ble安全机制初探)
    - [ble40安全机制](#ble40安全机制)
    - [ble42安全机制](#ble42安全机制)
- [mesh安全机制初探](#mesh安全机制初探)
- [参考资料](#参考资料)

<!-- /TOC -->

# 密码技术初探

在介绍密码技术之前，我们先给参与信息交互的对象赋予名称，方便举例和记忆。

<div align=center>重要角色一览表![](ImportantPerson.png)
</div>

Alice和Bob分别是两家银行，Bob银行通过网络向Alice银行发送了一条500元的汇款请求：<strong>从账户B-6789向账户A-1234汇款500元</strong>。


当然，会有人在网络中尝试攻击银行间通信，妄想用非法手段牟利，其中就有这样一个分工明确的组织，由以下成员组成：

- Eve
  - 窃听不同银行之间的消息，从中获取重要信息，如获知“从账户B-6789向账户A-1234汇款500元”。
- Mallory：
  - 篡改不同银行之间的消息，如修改汇款请求为“从账户B-6789向账户A-1234汇款5000000元”。
  - 伪装成Bob银行，以Bob银行名义发送一条新的汇款请求给Alice银行。

从上述例子可知消息面临的威胁有：`窃听`、`篡改`和`伪装`，对应的安全特性为：`机密性`、`一致性`、`是否已认证`。

“威胁”和“安全特性”的关系可以这样描述：
- 如果消息没有加密，消息则不具有机密性，无法防止他人窃听；
- 如果发送者发送的消息和接收者的消息是不同的，说明消息被篡改过，不具有一致性；
- 如果没有对消息进行认证，无法保证消息来自正确发送者而不是伪装者。

存在威胁，就会有对应的解决方法，下面会针对每个威胁介绍对应的密码技术。

## 对称密码

算法一般指复杂步骤，加密算法指的是用明文生成密文的步骤，解密的步骤称为解密算法，两者统称为密码算法，密码算法需要用到密钥。

所谓对称密码（symmetric cryptography）技术，即加密和解密时用的是同一个密钥，加密和解密的算法一般是公开的，如AES128。

<div align=center>![](SymmetricCryptography.png)对称密码应用图
</div>

**对称密码解决的问题**

如上图所示
1. Bob创建一条汇款请求消息；
2. 用密钥key对它加密；
3. 将加密后的消息发给Alice；
4. Alice收到密文；
5. Eve窃听到了加密后的消息，由于没有密钥key，无法解读内容；
6. Alice用密钥key对消息解密；
7. Alice获得一条汇款请求消息。

对称密码技术可以解决`窃听`的威胁。

**对称密码无法解决的问题**

对称密码技术可以解决`窃听`的威胁，但是有一个前提，就是在这之前发送者和接收者要有相同的密钥key，所以一定要先给接收者配送密钥，有以下几种方式：

1. Bob通过网络先将key发送给Alice，但容易被Eve截取到；
2. Bob乘坐交通工具将密钥key亲手交给Alice，或者其他网络以外的方式配送密钥，这种方式成本高维护麻烦，称为带外（Out-Of-Band）配送；
3. 用diffie-hellman密钥交换算法解决；
4. 用椭圆曲线diffie-hellman密钥交换算法解决。

## diffie-hellman密钥交换算法

先不管DH密钥交换算法是什么，我们现在关注问题是：在Eve窃听网络的情况下，如何解决Bob配送key给Alice的问题？

密码界的前辈们从数学角度上找到了答案：利用这个数学难题，Bob和Alice可以在Eve窃听的情况下，协商出一个密钥，而Eve不知道密钥是什么。

最好解决配送问题的办法就是不配送，通过协商获得相同的密钥，是不是很神奇，话不多说，我们看看是怎么实现的。

**离散对数问题**

背景知识：mod符号表达的意思是求余数，如表达式5 mod 7的计算思路为：5除以7等于0，余数为5，所以5 mod 7 = 5。

现有离散对数问题如下，请问满足公式的x是多少：

<div align=center>![](7^xmod13=8.png)</div>


为了求x，我们可以运用上面提到的背景知识来做计算，像下面这样依次尝试一遍，就可以得到x = 9。

<div align=center>![](7^xmod13=y.png)</div>

例子的数字较小，所以很快就找到答案了，当数字很大时，计算x就会变得非常耗时，快速求出离散对数的算法到现在还没被发现，所以可以得到这样的一个简单结论：

<div align=center>![](g^xmodp=y.png)</div>

对于上图公式，已知G、p、Y的时候，很难求出x。

接下来我们看看如何具体利用这个数学问题来协商出密钥的。

**diffie-hellman密钥交换算法应用**

在DH中，我们将Y称为公钥（public key），将x称为私钥（private key），则有以下结论：已知G、p、公钥的时候，很难求出私钥。

<div align=center>![](DH.png)DH应用图
</div>

如上图所示
1. Bob和Alice选择一个公开的G和p，Eve当然也知道这个公开的G和p；
2. Bob和Alice分别随机生成各自的私钥sb和sa；
3. Bob和Alice根据G、p以及各自的私钥，生成公钥pb和pa；
4. Bob和Alice互发公钥pb和pa，Eve窃听到了pb和pa；
5. Bob和Alice计算出共享密钥DHkey。

Eve能计算出DHkey吗？

对比三个角色最后的“已知信息”可知，只要Eve知道任一私钥（sb或sa），它就能容易算出DHkey，而这时候问题就变成了：Eve在已知G、p、公钥情况下，是否能求出私钥，这也就是我们上面提到的离散对数问题，这是很难做到的。

**diffie-hellman密钥交换算法解决的问题**

因为DH密钥交换算法利用了“离散对数问题”的复杂度，所以就算Eve一直窃听，Bob和Alice也能协商出一个共享密钥，而Eve却因为复杂的数学问题而没办法算出共享密钥，也就解决了对称密码中的配送问题。

## 椭圆曲线diffie-hellman密钥交换算法

DH是利用了“离散对数问题”的复杂度来实现密钥的安全交换的，如果将“离散对数问题”改为“椭圆曲线上的离散对数问题”，这样的算法就叫椭圆曲线diffie-hellman密钥交换（ECDH）。

两者密钥交换总体流程相同，只是利用的数学问题不同而已，ECDH能够用较短的密钥长度实现较高的安全性。

**椭圆曲线diffie-hellman密钥交换算法应用**

ECDH中的数学问题可以这样简单定义：

<div align=center>![](y=xg.png)</div>

已知椭圆曲线上的点Y、基点G的时候，很难求出x。其中算术符号`*`表示的不是普通的乘法，而是一种在椭圆曲线上的特殊算法。

在ECDH中，我们称Y为公钥（public key），x为私钥（private key）。

<div align=center>![](ECDH.png)ECDH应用图
</div>

如上图所示
1. Bob和Alice选择一条密码学家推荐的椭圆曲线，选择曲线上的一个基点G；
2. Bob和Alice分别随机生成各自的私钥sb和sa；
3. Bob和Alice根据G以及各自的私钥，生成公钥pb和pa；
4. Bob和Alice互发公钥pb和pa，Eve窃听到了pb和pa；
5. Bob和Alice计算出共享密钥DHkey。

**椭圆曲线diffie-hellman密钥交换算法无法解决的问题**

DH和ECDH都能解决密钥配送问题，结合对称密码技术，就能保证消息的机密性，防止被`窃听`了，但是对于`篡改`和`伪装`的攻击，却无能为力。为了解决剩下这两个威胁，就要靠其他技术手段了。

<div align=center>![](tamper.png)篡改示意图
</div>

如上图所示，Mallory不需要知道密文是什么意思，但是他可以修改密文，导致Alice解密出预期以外的内容。

<div align=center>![](camouflage.png)伪装示意图
</div>

如上图所示，Mallory夹在Bob和Alice之间并伪装他们。对于Mallory来说，DHkey是赤裸裸的，所以Bob和Alice互发的消息是没有机密性的，这种攻击也称为中间人攻击（MITM）。

## 消息认证码

消息认证码（MAC）技术是检查信息一致性并进行认证的技术，发送者通过MAC算法可以输出一个MIC值，接收者通过校验MIC值不仅可以判断消息一致性，还能判断消息是否来自正确的发送者。

<div align=center>![](MAC.png)</div>

MAC技术有一个重要性质：`单向性`，即<strong>给定MIC,很难通过MIC反算出明文（plaintext）</strong>。这也是认证与加密的一个区别，加密解密是双向的，可以互相推导，而认证只能单向。

<div align=center>![](authentication.png)消息一致性检查和认证示意图
</div>

**消息认证码解决的问题**

消息经过CMAC算法之后，为何Mallory无法篡改消息和伪装呢？

- Mallory如果想篡改明文，那就同时也要篡改MIC，否则无法通过Alice的校验，但是应该将MIC改成多少呢？因为Malloyr没有共享密钥，所以他也不知道MIC应该是什么。如果想篡改MIC，那就同时也要篡改明文才能通过Alice的校验，由于MAC算法的单向性，Mallory不知道明文应该是什么。

- Bob用CMAC算法认证一条消息并发给Alice，并要求Alice也用CMAC算法认证并返回一条消息给Bob。若Mallory伪装成Alice，由于没有认证密钥，无法返回通过Bob校验的消息。

**消息认证码无法解决的问题**

没错，要使用MAC技术，首先要有相同的认证密钥，又回到了之前的密钥配送问题，具体这里采用哪种方式解决配送密钥问题，视实际情况而定。

## 信息安全小结

<div align=center>![](SecurityTechnology.png)威胁、安全特性、密码技术关系图
</div>

总结：
- 为了解决`窃听`问题，采用对称密码技术；
- 为了解决对称密码技术的加密密钥配送问题，采用配送密钥技术；
- 为了解决`篡改`问题，采用消息认证码技术；
- 为了解决`伪装`问题，采用消息认证码技术；
- 为了解决消息认证码技术的认证密钥配送问题，采用配送密钥技术。

> Tips：无论消息认证码技术还是对称密码技术，都需要用到配送密钥技术，而不同的配送密钥技术本身，也会涉及到认证强度的问题。比如你希望用ECDH来解决消息认证码的认证密钥配送问题，但是ECDH本身认证强度为零，然后又要使用消息认证码技术，导致进入了死循环。所以需要选择合适的密钥配送技术，常见的有：邮箱验证码、手机短信验证码、NFC、目测法等。

# ble安全机制初探


在介绍ble安全机制之前，我们先给参与信息交互的对象赋予名称，方便举例和记忆。

<div align=center>ble重要角色一览表![](BleImportantPerson.png)
</div>

背景知识：简单来说ble设备可分为两种角色，一种是主机角色（master），另一种是从机角色（slave），有以下几种差异：

1. 建立连接前
    - 主机能进入扫描状态、发起连接状态，不能进入广播状态；
    - 从机能进入广播状态，不能进入扫描状态和发起连接状态；
    - 一定是由主机发起连接，从机只能被连接。

2. 建立连接后
    - 一定是由主机发起配对，从机只能请求主机发起配对；


<div align=center>![](KindOfPhase.png)ble角色生命线
</div>

- 广播状态：设备正在往空中发送广播包，谁都可以收得到；
- 扫描状态：设备正在接收空中的广播包，看看谁在发，发什么；
- 发起连接状态：设备指定与另外一个设备发起连接；
- 明文数传阶段：两个已连接设备之间用明文传送数据包；
- 配对阶段：两个已连接设备之间运用密码技术生成各种安全强度的密钥；
- 密文数传阶段：两个已连接设备之间用密文传送数据包。
- 加密过程：两个已连接设备之间直接使用之前配对阶段输出的密钥，跳过配对。

除了展示两种角色的差异，博主还希望通过上图澄清几个概念：

1. 复杂密码技术是运用在已连接之后的配对阶段，所以不存在配对失败，导致ble无法正常建立连接，至多是配对失败，导致连接断开。
2. 连接后，不一定要启动配对，如果明文数传已经满足应用要求，就没必要启动配对了。
3. 如果有保存之前配对输出的密钥，那么可以直接进入加密过程，跳过配对阶段，加快进入密文数传阶段。

## ble40安全机制

思路：配对过程得到STK/LTK，过程中认证，衍生sessionKey，sessionKey用于CCM，介绍CCM，CCM = pf_auth + pf_enc

## ble42安全机制

 (ECDH/CMAC/CCM)
思路：4.0的配送问题引出ECDH，增加CMAC过程（不一定写），最后也是用CCM。

# mesh安全机制初探

思路：配网过程引入ECDH（待定)。



# 参考资料
- 《图解密码技术》
- [BLE配对过程详解](http://bbs.21ic.com/blog-1827100-160300.html)
- [BLE核心规范](https://www.bluetooth.com/specifications/bluetooth-core-specification/)
