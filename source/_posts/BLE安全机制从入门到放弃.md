---
title: BLE安全机制从入门到放弃
date: 2019-05-14 13:02:11
tags:
- BLE
- 安全机制
- 蓝牙

categories:
- 一得之见

top: true
---

网上介绍BLE安全机制的文章大多只关注业务概念，如：配对加密是什么，绑定过程是什么；而忽略了其中涉及到的信息安全知识，如：使用了加密和认证有什么用，不用又会怎么样。让新人读了有种云里雾里，知其然而不知其所以然的感觉。这里结合涉及到的信息安全知识，换一个角度来认识BLE安全机制。
<!-- more --> 

前言
===

标题中的“放弃”有点调侃的意思，是指读者在读完之后，可以不依赖别人，靠自己读蓝牙核心规范加深认识，这样收获也会更多，也是这篇博文的目标。

为了易于理解，会对蓝牙核心规范以及组网规范中的算法进行裁剪，但是原理是不变的，标准算法应参考蓝牙核心规范以及组网规范。

最后，这是博主的一得之见，欢迎各位指正。

目录
===
<!-- TOC -->

- [密码技术初探](#密码技术初探)
    - [对称密码](#对称密码)
    - [Diffie-Hellman密钥交换算法](#diffie-hellman密钥交换算法)
    - [椭圆曲线Diffie-Hellman密钥交换算法](#椭圆曲线diffie-hellman密钥交换算法)
    - [消息认证码 （CMAC）](#消息认证码-cmac)
    - [信息安全小结](#信息安全小结)
- [BLE安全机制初探](#ble安全机制初探)
    - [BLE4.0安全机制](#ble40安全机制)
    - [BLE4.2安全机制 (ECDH/CMAC/CCM)](#ble42安全机制-ecdhcmacccm)
- [BLE MESH安全机制初探](#ble-mesh安全机制初探)
- [参考资料](#参考资料)

<!-- /TOC -->


# 密码技术初探

在介绍密码技术之前，我们先给参与信息交互的对象赋予名称，方便举例和记忆。

<div align=center> 重要角色一览表 ![](ImportantPerson.png)
</div>

Alice和Bob分别是两家银行，Alice银行通过网络向Bob银行发送了一条500元的汇款请求：<strong>从账户A-1234向账户B-7890汇款500元</strong>。


当然，会有人在网络中尝试攻击银行间通信，妄想用非法手段牟利，其中就有这样一个分工明确的组织，由以下成员组成：

- Eve
  - 窃听不同银行之间的消息，从中获取重要信息，如获知“从账户A-1234向账户B-7890汇款500元”。
- Mallory：
  - 篡改不同银行之间的消息，如修改汇款请求为“从账户A-1234向账户B-7890汇款5000000元”。
  - 伪装成Alice银行，以Alice银行名义发送一条新的汇款请求给Bob银行。

从上述例子可知消息面临的威胁有：`窃听`、`篡改`和`伪装`，对应的安全特性为：`机密性`、`一致性`、`是否已认证`。

“威胁”和“安全特性”的关系可以这样描述：
- 如果消息没有加密，消息则不具有机密性，无法防止他人窃听；
- 如果发送者发送的消息和接收者的消息是不同的，说明消息被篡改过，不具有一致性；
- 如果没有对消息进行认证，无法保证消息来自正确发送者而不是伪装者。

存在威胁，就会有对应的解决方法，下面会针对每个威胁介绍对应的密码技术。

## 对称密码

算法一般指复杂步骤，加密算法指的是用明文生成密文的步骤，解密的步骤称为解密算法，两者统称为密码算法，密码算法需要用到密钥。

所谓对称密码（symmetric cryptography）技术，即加密和解密时用的是同一个密钥，加密和解密的算法一般是公开的，如AES128。

<div align=center> ![](SymmetricCryptography.png) 对称密码应用图
</div>

**对称密码解决的问题**

如上图所示
1. Bob创建一条汇款请求消息；
2. 用密钥key对它加密；
3. 将加密后的消息发给Alice；
4. Alice收到密文；
5. Eve窃听到了加密后的消息，由于没有密钥key，无法解读内容；
6. Alice用密钥key对消息解密；
7. Alice获得一条汇款请求消息。

对称密码技术可以解决`窃听`的威胁。

**对称密码无法解决的问题**

对称密码技术可以解决`窃听`的威胁，但是有一个前提，就是在这之前发送者和接收者要有相同的密钥key，所以一定要先给接收者配送密钥，有以下几种方式：

1. Bob通过网络先将key发送给Alice，但容易被Eve截取到；
2. Bob乘坐交通工具将密钥key亲手交给Alice，或者其他网络以外的方式配送密钥，这种方式成本高维护麻烦，称为带外（Out-Of-Band）配送；
3. 用Diffie-Hellman密钥交换算法解决；
4. 用椭圆曲线Diffie-Hellman密钥交换算法解决。

## Diffie-Hellman密钥交换算法

先不管DH密钥交换算法是什么，我们现在关注问题是：在Eve窃听网络的情况下，如何解决Bob配送key给Alice的问题？

密码界的前辈们从数学角度上找到了答案：利用这个数学难题，Bob和Alice可以在Eve窃听的情况下，协商出一个密钥，而Eve不知道密钥是什么。

最好解决配送问题的办法就是不配送，通过协商获得相同的密钥，是不是很神奇，话不多说，我们看看是怎么实现的。

**离散对数问题**

背景知识：mod符号表达的意思是求余数，如表达式5 mod 7的计算思路为：5除以7等于0，余数为5，所以5 mod 7 = 5。

现有离散对数问题如下，请问满足公式的x是多少：

<div align=center>![](7^xmod13=8.png)</div>

为了求x，我们可以运用上面提到的背景知识来做计算，像下面这样依次尝试一遍，就可以得到x = 9。

<div align=center>![](7^xmod13=y.png)</div>

例子的数字较小，所以很快就找到答案了，当数字很大时，计算x就会变得非常耗时，快速求出离散对数的算法到现在还没被发现，所以可以得到这样的一个简单结论：

<div align=center>![](g^xmodp=y.png)</div>

对于上图公式，已知G、p、Y的时候，很难求出x。

接下来我们看看如何具体利用这个数学问题来协商出密钥的。

**Diffie-Hellman密钥交换算法应用**

在DH中，我们将Y称为公钥（public key），将x称为私钥（private key），则有以下结论：

已知G、p、公钥的时候，很难求出私钥。

<div align=center>![](DH.png)</div>

如上图所示
1. Bob和Alice选择一个公开的G和p，Eve当然也知道这个公开的G和p；
2. Bob和Alice分别随机生成各自的私钥sb和sa；
3. Bob和Alice根据G、p以及各自的私钥，生成公钥pb和pa；
4. Bob和Alice互发公钥pb和pa，Eve窃听到了pb和pa；
5. Bob和Alice计算出共享密钥DHkey。

Eve能计算出DHkey吗？

对比三个角色最后的“已知信息”可知，只要Eve知道任一私钥（sb或sa），它就能容易算出DHkey，而这时候问题就变成了：Eve在已知G、p、公钥情况下，是否能求出私钥，这也就是我们上面提到的离散对数问题，这是很难做到的。

**Diffie-Hellman密钥交换算法解决的问题**

因为DH密钥交换算法利用了“离散对数问题”的复杂度，所以就算Eve一直窃听，Bob和Alice也能协商出一个共享密钥，而Eve却因为复杂的数学问题而没办法算出共享密钥，也就解决了对称密码中的配送问题。

## 椭圆曲线Diffie-Hellman密钥交换算法

DH是利用了“离散对数问题”的复杂度来实现密钥的安全交换的，如果将“离散对数问题”改为“椭圆曲线上的离散对数问题”，这样的算法就叫椭圆曲线Diffie-Hellman密钥交换（ECDH）。

两者密钥交换总体流程相同，只是利用的数学问题不同而已，ECDH能够用较短的密钥长度实现较高的安全性。

**椭圆曲线Diffie-Hellman密钥交换算法应用**

ECDH中的数学问题可以这样简单定义：

<div align=center>![](y=xg.png)</div>

已知椭圆曲线上的点Y、基点G的时候，很难求出x。其中算术符号`*`表示的不是普通的乘法，而是一种在椭圆曲线上的特殊算法。

在ECDH中，我们称Y为公钥（public key），x为私钥（private key）。

<div align=center>![](ECDH.png)</div>

如上图所示
1. Bob和Alice选择一条密码学家推荐的椭圆曲线，选择曲线上的一个基点G；
2. Bob和Alice分别随机生成各自的私钥sb和sa；
3. Bob和Alice根据G以及各自的私钥，生成公钥pb和pa；
4. Bob和Alice互发公钥pb和pa，Eve窃听到了pb和pa；
5. Bob和Alice计算出共享密钥DHkey。

**椭圆曲线Diffie-Hellman密钥交换算法无法解决的问题**

DH和ECDH都能解决密钥配送问题，结合对称密码技术，就能保证消息的机密性，防止被`窃听`了，但是对于`篡改`和`伪装`的攻击，却无能为力。为了解决剩下这两个威胁，就要靠其他技术手段了。

## 消息认证码 （CMAC）
## 信息安全小结
- 总结上述例子中，用到了多少种密钥

# BLE安全机制初探
## BLE4.0安全机制


思路：配对过程得到STK/LTK，过程中认证，衍生sessionKey，sessionKey用于CCM，介绍CCM，CCM = pf_auth + pf_enc

## BLE4.2安全机制 (ECDH/CMAC/CCM)

思路：4.0的配送问题引出ECDH，增加CMAC过程（不一定写），最后也是用CCM。

# BLE MESH安全机制初探

思路：配网过程引入ECDH（待定)。



# 参考资料
- 《图解密码技术》
- [BLE配对过程详解](http://bbs.21ic.com/blog-1827100-160300.html)
- [BLE核心规范](https://www.bluetooth.com/specifications/bluetooth-core-specification/)
